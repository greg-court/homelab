apiVersion: batch/v1
kind: CronJob
metadata:
  name: config-backups
  namespace: unifi # same ns to mount the UniFi PVC
  labels:
    app: config-backups
    egress.zone: infra
spec:
  schedule: '30 3 * * *' # daily @ 03:30
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: runner
              image: curlimages/curl:8.10.1
              command: ['/bin/sh', '-c', '/scripts/backup.sh']
              envFrom:
                - secretRef: { name: config-backups-env }
              env:
                - name: SSL_CERT_FILE
                  value: /etc/ssl/certs/homelab-ca.crt
              volumeMounts:
                - { name: scripts, mountPath: /scripts, readOnly: true }
                - { name: unifi-data, mountPath: /unifi-data, readOnly: true }
                - {
                    name: homelab-ca,
                    mountPath: /etc/ssl/certs/homelab-ca.crt,
                    subPath: homelab-ca.crt,
                    readOnly: true,
                  }
          volumes:
            - name: scripts
              configMap:
                name: config-backups-scripts
                defaultMode: 0755
            - name: unifi-data
              persistentVolumeClaim:
                # From StatefulSet 'unifi', volumeClaimTemplates name 'data' -> data-unifi-0
                claimName: data-unifi-0
            - name: homelab-ca
              configMap:
                name: homelab-ca
                items:
                  - key: homelab-ca.crt
                    path: homelab-ca.crt

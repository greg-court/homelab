apiVersion: batch/v1
kind: CronJob
metadata:
  name: config-backups
  namespace: unifi
  labels:
    app: config-backups
    egress.zone: infra
spec:
  schedule: '30 3 * * *' # daily @ 03:30
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 1800
      template:
        spec:
          securityContext:
            fsGroup: 1001
            fsGroupChangePolicy: OnRootMismatch
          restartPolicy: OnFailure
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: app
                        operator: In
                        values: [unifi]
                  topologyKey: kubernetes.io/hostname
          containers:
            - name: runner
              image: curlimages/curl:8.10.1
              command: ['/bin/sh', '-c', '/scripts/backup.sh']
              envFrom:
                - secretRef: { name: config-backups-env }
              volumeMounts:
                - { name: scripts, mountPath: /scripts, readOnly: true }
                - { name: unifi-data, mountPath: /unifi-data, readOnly: true }
                - { name: work, mountPath: /work }
          volumes:
            - name: scripts
              configMap:
                name: config-backups-scripts
                defaultMode: 0755
            - name: unifi-data
              persistentVolumeClaim:
                claimName: data-unifi-0
            - name: work
              emptyDir: {}

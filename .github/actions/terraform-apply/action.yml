name: 'Terraform Apply'
description: 'Runs all steps to apply a Terraform plan.'

inputs:
  path:
    description: 'The path to the Terraform code'
    required: true
  name:
    description: 'The short name of the component'
    required: true
  action:
    description: 'Terraform action: plan or destroy'
    required: false
    default: 'apply'

runs:
  using: 'composite'
  steps:
    - name: Configure Azure Credentials (OIDC)
      uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
      with:
        client-id: ${{ env.AZURE_CLIENT_ID }}
        tenant-id: ${{ env.AZURE_TENANT_ID }}
        subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

    - name: Download saved plan
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
      with:
        name: tfplan-${{ inputs.name }}
        path: ${{ inputs.path }}

    - name: Terraform Init
      shell: bash
      working-directory: ${{ inputs.path }}
      run: terraform init -input=false

    - name: Terraform Apply
      shell: bash
      working-directory: ${{ inputs.path }}
      run: terraform apply -auto-approve tfplan
